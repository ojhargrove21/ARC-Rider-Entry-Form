<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5,user-scalable=yes">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      box-sizing: border-box;
      background: #f9f9f9;
    }

    body {
      padding: 20px;
      margin: auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    label, .section_label {
      font-weight: bold;
      display: block;
      margin-top: 15px;
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      margin-bottom: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    input[readonly] { background-color: #eee; }

    .section-divider {
      border-top: 1px solid #ccc;
      margin: 30px 0;
    }

    /* Dropdown desktop */
    .dropdown {
      position: relative;
      width: 100%;
    }

    .dropdown button {
      width: 100%;
      text-align: left;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      z-index: 10;
      box-sizing: border-box;
    }

    .dropdown-content label {
      display: block;
      padding: 5px 10px;
      cursor: pointer;
    }

    .dropdown-content label:hover { background-color: #f0f0f0; }

    /* Modal for mobile */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background-color: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: #fff;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      border-radius: 8px;
      padding: 20px;
      box-sizing: border-box;
    }

    .modal-header {
      font-weight: bold;
      margin-bottom: 10px;
    }

    .modal label {
      display: block;
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #ddd;
    }

    .modal button { margin-top: 10px; }
  </style>
  <title>Entry Form</title>
</head>
<body>
  <h1 role="main">Entry Form</h1>

  <label for="number">Rider Number:</label>
  <input id="number" list="riderNumbers" placeholder="Select or type Rider Number" onchange="loadRider()">
  <datalist id="riderNumbers"></datalist>

  <label for="firstName">First Name:</label>
  <input id="firstName" readonly>

  <label for="lastName">Last Name:</label>
  <input id="lastName" readonly>

  <label for="age">Age:</label>
  <input id="age" type="number">

  <label for="division">Division</label>
  <select id="division" onchange="loadCheckboxes()">
    <option value="">-- Select Division --</option>
  </select>

  <label for="horse">Horse Name:</label>
  <input id="horse" readonly>

  <div class="section-divider"></div>

  <div class="section_label">Select Classes:</div>
  <div class="dropdown" id="dropdownContainer">
    <button type="button" id="classDropdownBtn">Select Classes</button>
    <div class="dropdown-content" id="classDropdownContent"></div>
  </div>

  <div class="modal" id="classModal">
    <div class="modal-content" id="classModalContent">
      <div class="modal-header">Select Classes</div>
      <div id="modalCheckboxes"></div>
      <button type="button" onclick="closeModal()">Done</button>
    </div>
  </div>

  <button type="button" onclick="submitForm()">Submit</button>

  <script>
    // ✅ MUST be the deployed /exec URL, not /dev
    const API_BASE = "https://script.google.com/macros/s/AKfycbxqVu8AmUTxXILaIYUXiv2bnbMjYeBsrb6ubixmrnOBsXSpIm4i-OfSaCcta067q3A5Kw/exec";

    /****************************************************
     * CLIENT CACHE (Version-based)
     * - Calls getVersion once per page load (and periodically)
     * - Clears localStorage cache if version changed
     * - Caches every GET response in localStorage
     ****************************************************/
    const CACHE_PREFIX = "entryform:";
    const VERSION_KEY = CACHE_PREFIX + "version";
    const CACHE_TTL_MS = 6 * 60 * 60 * 1000; // 6h safety fallback

    async function rawApiGet(action, params = {}) {
      const url = new URL(API_BASE);
      url.searchParams.set("action", action);
      Object.entries(params).forEach(([k, v]) => {
        if (v !== undefined && v !== null) url.searchParams.set(k, v);
      });

      const res = await fetch(url.toString(), { method: "GET", redirect: "follow" });
      if (!res.ok) throw new Error("GET failed: " + res.status);
      return await res.json();
    }

    async function getServerVersion() {
      const r = await rawApiGet("getVersion");
      return String(r.version || "0");
    }

    function clearAllCache() {
      Object.keys(localStorage).forEach(k => {
        if (k.startsWith(CACHE_PREFIX) && k !== VERSION_KEY) localStorage.removeItem(k);
      });
    }

    function cacheKeyFor(action, params) {
      return CACHE_PREFIX + action + ":" + JSON.stringify(params || {});
    }

    function readCache(key) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || typeof obj !== "object") return null;
        if (!obj.savedAt || (Date.now() - obj.savedAt) > CACHE_TTL_MS) return null;
        return obj.data;
      } catch {
        return null;
      }
    }

    function writeCache(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify({ savedAt: Date.now(), data }));
      } catch {
        // if storage is full / blocked, just skip caching
      }
    }

    let _versionPromise = null;

    async function ensureVersionFresh() {
      if (!_versionPromise) {
        _versionPromise = (async () => {
          const serverV = await getServerVersion();
          const localV = localStorage.getItem(VERSION_KEY);

          if (localV !== serverV) {
            // Version changed => dump cached GET responses
            clearAllCache();
            localStorage.setItem(VERSION_KEY, serverV);
          }
          return serverV;
        })();
      }
      return _versionPromise;
    }

    async function apiGet(action, params = {}) {
      // Ensure cache invalidation is handled first
      await ensureVersionFresh();

      // Do not cache version call itself
      if (action === "getVersion") return rawApiGet(action, params);

      const key = cacheKeyFor(action, params);
      const cached = readCache(key);
      if (cached !== null) return cached;

      const data = await rawApiGet(action, params);

      // If server returns an error object, don't cache it
      if (data && typeof data === "object" && data.error) return data;

      writeCache(key, data);
      return data;
    }

    // Optional: re-check version every 2 minutes (keeps long-open page accurate)
    setInterval(() => { _versionPromise = null; ensureVersionFresh().catch(() => {}); }, 120000);

    // ---------- helpers ----------
    function setFieldState(readOnly) {
      ["firstName", "lastName", "horse"].forEach(id => document.getElementById(id).readOnly = readOnly);
    }

    // ---------- init ----------
    document.addEventListener("DOMContentLoaded", async () => {
      await populateDivisions();
      await buildRiderNumberList();
    });

    // ---------- divisions ----------
    async function populateDivisions() {
      const divisions = await apiGet("getDivisions");
      const select = document.getElementById("division");
      divisions.forEach(d => {
        const option = document.createElement("option");
        option.value = d;
        option.textContent = d;
        select.appendChild(option);
      });
    }

    // ---------- rider numbers (include 1-200 + >200 in sheet) ----------
    async function buildRiderNumberList() {
      const existingMap = await apiGet("getRiderNumberMap"); // { "1":"First Last", "203":"..." ...}

      const datalist = document.getElementById("riderNumbers");
      datalist.innerHTML = "";

      // Always include 1–200 (even if not in sheet)
      for (let i = 1; i <= 200; i++) {
        const option = document.createElement("option");
        option.value = i;
        if (existingMap[i]) option.label = existingMap[i];
        datalist.appendChild(option);
      }

      // Include >200 from sheet
      Object.keys(existingMap)
        .map(Number)
        .filter(n => n > 200)
        .sort((a, b) => a - b)
        .forEach(n => {
          const option = document.createElement("option");
          option.value = n;
          option.label = existingMap[n];
          datalist.appendChild(option);
        });
    }

    // ---------- load rider ----------
    async function loadRider() {
      const number = document.getElementById("number").value;
      if (!number) return;

      const rider = await apiGet("findRider", { number });

      if (rider.exists) {
        firstName.value = rider.firstName || "";
        lastName.value = rider.lastName || "";
        age.value = rider.age || "";
        horse.value = rider.horse || "";
        setFieldState(true);
      } else {
        firstName.value = "";
        lastName.value = "";
        age.value = "";
        horse.value = "";
        setFieldState(false);
      }
    }

    // ---------- load classes ----------
    async function loadCheckboxes() {
      const division = document.getElementById("division").value;
      if (!division) return;

      const items = await apiGet("getClasses", { division });
      renderClasses(items);
    }

    function renderClasses(items) {
      const desktopContainer = document.getElementById("classDropdownContent");
      const modalContainer = document.getElementById("modalCheckboxes");
      desktopContainer.innerHTML = "";
      modalContainer.innerHTML = "";

      items.forEach((item, i) => {
        // Desktop
        const label = document.createElement("label");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = item;
        cb.id = "class_" + i;
        label.appendChild(cb);
        label.appendChild(document.createTextNode(" " + item));
        desktopContainer.appendChild(label);

        // Mobile modal
        const mlabel = document.createElement("label");
        const mcb = document.createElement("input");
        mcb.type = "checkbox";
        mcb.value = item;
        mcb.id = "modal_" + i;
        mlabel.appendChild(mcb);
        mlabel.appendChild(document.createTextNode(" " + item));
        modalContainer.appendChild(mlabel);
      });
    }

    // Dropdown toggle
    document.getElementById("classDropdownBtn").addEventListener("click", () => {
      if (window.innerWidth > 600) {
        const container = document.getElementById("classDropdownContent");
        container.style.display = container.style.display === "block" ? "none" : "block";
      } else {
        document.getElementById("classModal").style.display = "flex";
        syncModalCheckboxes();
      }
    });

    function closeModal() {
      document.getElementById("classModal").style.display = "none";
      syncDesktopCheckboxes();
    }

    function syncDesktopCheckboxes() {
      const modalChecks = document.querySelectorAll("#modalCheckboxes input");
      const desktopChecks = document.querySelectorAll("#classDropdownContent input");
      modalChecks.forEach((mcb, i) => { if (desktopChecks[i]) desktopChecks[i].checked = mcb.checked; });
    }

    function syncModalCheckboxes() {
      const modalChecks = document.querySelectorAll("#modalCheckboxes input");
      const desktopChecks = document.querySelectorAll("#classDropdownContent input");
      modalChecks.forEach((mcb, i) => { if (desktopChecks[i]) mcb.checked = desktopChecks[i].checked; });
    }

    // ---------- submit ----------
    async function submitForm() {
      const selected = [...document.querySelectorAll("#classDropdownContent input:checked")].map(cb => cb.value);

      const data = {
        number: number.value,
        firstName: firstName.value,
        lastName: lastName.value,
        age: +age.value,
        division: division.value,
        horse: horse.value,
        classes: selected
      };

      if (!data.number || data.classes.length === 0) {
        alert("Rider Number and at least one class are required.");
        return;
      }

      // ✅ Simple POST (application/x-www-form-urlencoded) => no preflight
      const body = new URLSearchParams();
      body.set("action", "submitForm");
      body.set("payload", JSON.stringify(data));

      const res = await fetch(API_BASE, { method: "POST", body, redirect: "follow" });
      const out = await res.json().catch(() => ({}));

      if (!res.ok || out.error) {
        console.error("Submit error:", out);
        alert("Submit failed: " + (out.error || res.statusText));
        return;
      }

      // After a successful submit, server version has changed.
      // Force a version refresh so cached GETs re-pull next time.
      _versionPromise = null;
      await ensureVersionFresh().catch(() => {});
      // Optionally refresh local UI lists:
      // await buildRiderNumberList();

      alert("Form submitted!");
    }

    // ----- CLOSE MODAL ONLY WHEN CLICKING THE BACKDROP -----
    const classModal = document.getElementById("classModal");
    const classModalContent = document.getElementById("classModalContent");

    classModal.addEventListener("click", (e) => {
      if (e.target === classModal) closeModal();
    });

    classModalContent.addEventListener("click", (e) => {
      e.stopPropagation();
    });

    // ----- CLOSE DESKTOP DROPDOWN WHEN CLICKING OUTSIDE -----
    const dropdownContainer = document.getElementById("dropdownContainer");
    const dropdownContent = document.getElementById("classDropdownContent");

    document.addEventListener("click", (e) => {
      if (window.innerWidth <= 600) return;
      if (!dropdownContainer.contains(e.target)) dropdownContent.style.display = "none";
    });

    // ----- ESC KEY CLOSES MODAL & DROPDOWN -----
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        if (classModal.style.display === "flex") closeModal();
        dropdownContent.style.display = "none";
      }
    });
  </script>
</body>
</html>
