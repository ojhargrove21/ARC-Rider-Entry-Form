<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5,user-scalable=yes">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      box-sizing: border-box;
      background: #f9f9f9;
    }

    body { padding: 20px; margin: auto; }

    h1 { text-align: center; margin-bottom: 20px; }

    label, .section_label {
      font-weight: bold;
      display: block;
      margin-top: 15px;
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      margin-bottom: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    input[readonly] { background-color: #eee; }

    .section-divider {
      border-top: 1px solid #ccc;
      margin: 30px 0;
    }

    /* Desktop dropdown container still exists but we will always use modal */
    .dropdown { position: relative; width: 100%; }

    /* Modal (now used on ALL screen sizes) */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background-color: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: #fff;
      width: 90%;
      max-width: 520px;          /* a little wider for desktop */
      max-height: 80vh;
      overflow-y: auto;
      border-radius: 8px;
      padding: 20px;
      box-sizing: border-box;
    }

    .modal-header { font-weight: bold; margin-bottom: 10px; }

    .modal label {
      display: block;
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #ddd;
    }

    .modal button { margin-top: 10px; }

    /* Hide the old desktop dropdown content since we’re not using it */
    #classDropdownContent { display: none !important; }
  </style>
  <title>Entry Form</title>
</head>

<body>
  <h1 role="main">Entry Form</h1>

  <label for="number">Rider Number:</label>
  <input id="number" list="riderNumbers" placeholder="Select or type Rider Number" onchange="loadRider()">
  <datalist id="riderNumbers"></datalist>

  <label for="firstName">First Name:</label>
  <input id="firstName" readonly>

  <label for="lastName">Last Name:</label>
  <input id="lastName" readonly>

  <label for="age">Age:</label>
  <input id="age" type="number">

  <label for="division">Division</label>
  <select id="division" onchange="loadCheckboxes()">
    <option value="">-- Select Division --</option>
  </select>

  <label for="horse">Horse Name:</label>
  <input id="horse" readonly>

  <div class="section-divider"></div>

  <div class="section_label">Select Classes:</div>
  <div class="dropdown" style="background-color:#fff;" id="dropdownContainer">
    <button type="button" style="background-color:#fff; text-align:left;" id="classDropdownBtn">-- Select Classes --</button>
    <!-- kept for compatibility with existing code (not used) -->
    <div id="classDropdownContent"></div>
  </div>

  <!-- ✅ Modal used on BOTH mobile + desktop -->
  <div class="modal" id="classModal" aria-modal="true" role="dialog" aria-labelledby="classModalTitle">
    <div class="modal-content" id="classModalContent">
      <div class="modal-header" id="classModalTitle">Select Classes</div>
      <div id="modalCheckboxes"></div>
      <button type="button" onclick="closeModal()">Done</button>
    </div>
  </div>

  <button type="button" onclick="submitForm()">Submit</button>

  <script>
    // ✅ MUST be the deployed /exec URL, not /dev
    const API_BASE = "https://script.google.com/macros/s/AKfycbwLxeapKQYpaYUNvsvGUZ71fFPXWVBGjlEPXSpmweTLs_YcPgkdvCBcu_whm74Ml3WH1Q/exec";

    /*****************************************************************
     * INLINE LOADING PLACEHOLDERS (per area being loaded)
     *****************************************************************/
    function setLoadingButton(btnEl, isLoading, loadingText = "Loading...", normalText = "Select Classes") {
      if (!btnEl) return;
      if (isLoading) {
        btnEl.dataset.normalText = btnEl.textContent || normalText;
        btnEl.textContent = loadingText;
        btnEl.disabled = true;
        btnEl.setAttribute("aria-busy", "true");
      } else {
        btnEl.textContent = btnEl.dataset.normalText || normalText;
        btnEl.disabled = false;
        btnEl.removeAttribute("aria-busy");
      }
    }

    function setLoadingSelect(selectEl, isLoading, loadingText = "Loading...", normalText = "-- Select Division --") {
      if (!selectEl) return;
      if (!selectEl.options.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = normalText;
        selectEl.appendChild(opt);
      }
      if (isLoading) {
        selectEl.dataset.normalText = selectEl.options[0].textContent || normalText;
        selectEl.options[0].textContent = loadingText;
        selectEl.disabled = true;
        selectEl.setAttribute("aria-busy", "true");
      } else {
        selectEl.options[0].textContent = selectEl.dataset.normalText || normalText;
        selectEl.disabled = false;
        selectEl.removeAttribute("aria-busy");
      }
    }

    function setLoadingInputPlaceholder(inputEl, isLoading, loadingText = "Loading...") {
      if (!inputEl) return;
      if (isLoading) {
        inputEl.dataset.normalPlaceholder = inputEl.placeholder || "";
        inputEl.placeholder = loadingText;
        inputEl.disabled = true;
        inputEl.setAttribute("aria-busy", "true");
      } else {
        inputEl.placeholder = inputEl.dataset.normalPlaceholder || inputEl.placeholder || "";
        inputEl.disabled = false;
        inputEl.removeAttribute("aria-busy");
      }
    }

    /*****************************************************************
     * GROUPED CACHE (per "page/sheet group") using getVersions
     *****************************************************************/
    const CACHE_PREFIX = "entryform:";
    const VERSION_STORE_KEY = CACHE_PREFIX + "versions";
    const CACHE_TTL_MS = 6 * 60 * 60 * 1000; // safety fallback (6h)

    function groupForAction(action) {
      switch (action) {
        case "getRiderNumberMap":
        case "findRider":
          return "riders";
        case "getDivisions":
          return "divisions";
        case "getClasses":
          return "classes";
        default:
          return "misc";
      }
    }

    function dependsOnVersions(group) {
      switch (group) {
        case "riders":
          return ["riders"];
        case "divisions":
          return ["divisions"];
        case "classes":
          return ["events", "classes", "altClasses"];
        default:
          return ["events", "classes", "altClasses", "riders", "divisions", "entries"];
      }
    }

    async function rawApiGet(action, params = {}) {
      const url = new URL(API_BASE);
      url.searchParams.set("action", action);
      Object.entries(params).forEach(([k, v]) => {
        if (v !== undefined && v !== null) url.searchParams.set(k, v);
      });

      const res = await fetch(url.toString(), { method: "GET", redirect: "follow" });
      if (!res.ok) throw new Error("GET failed: " + res.status);
      return await res.json();
    }

    async function rawApiPost(action, payloadObj) {
      const body = new URLSearchParams();
      body.set("action", action);
      body.set("payload", JSON.stringify(payloadObj || {}));

      const res = await fetch(API_BASE, { method: "POST", body, redirect: "follow" });
      const out = await res.json().catch(() => ({}));
      return { res, out };
    }

    function loadLocalVersions() {
      try {
        const raw = localStorage.getItem(VERSION_STORE_KEY);
        if (!raw) return null;
        const v = JSON.parse(raw);
        if (!v || typeof v !== "object") return null;
        return v;
      } catch {
        return null;
      }
    }

    function saveLocalVersions(v) {
      try { localStorage.setItem(VERSION_STORE_KEY, JSON.stringify(v)); } catch {}
    }

    function clearGroupCache(group) {
      const prefix = `${CACHE_PREFIX}${group}:`;
      Object.keys(localStorage).forEach(k => {
        if (k.startsWith(prefix)) localStorage.removeItem(k);
      });
    }

    function cacheKeyFor(group, action, params) {
      return `${CACHE_PREFIX}${group}:${action}:${JSON.stringify(params || {})}`;
    }

    function readCache(key) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || typeof obj !== "object") return null;
        if (!obj.savedAt) return null;
        if ((Date.now() - obj.savedAt) > CACHE_TTL_MS) return null;
        return obj.data;
      } catch {
        return null;
      }
    }

    function writeCache(key, data) {
      try { localStorage.setItem(key, JSON.stringify({ savedAt: Date.now(), data })); } catch {}
    }

    let _versionsPromise = null;

    async function ensureVersionsFresh() {
      if (_versionsPromise) return _versionsPromise;

      _versionsPromise = (async () => {
        const serverV = await rawApiGet("getVersions");
        const normalizedServerV = {
          riders: String(serverV.riders || "0"),
          divisions: String(serverV.divisions || "0"),
          classes: String(serverV.classes || "0"),
          altClasses: String(serverV.altClasses || "0"),
          events: String(serverV.events || "0"),
          entries: String(serverV.entries || "0"),
        };

        const localV = loadLocalVersions();

        if (!localV) {
          saveLocalVersions(normalizedServerV);
          return normalizedServerV;
        }

        const changed = [];
        Object.keys(normalizedServerV).forEach(k => {
          if (String(localV[k] || "0") !== String(normalizedServerV[k] || "0")) changed.push(k);
        });

        if (changed.length) {
          const groups = ["riders", "divisions", "classes", "misc"];
          groups.forEach(g => {
            const deps = dependsOnVersions(g);
            const hit = deps.some(dep => changed.includes(dep));
            if (hit) clearGroupCache(g);
          });
          saveLocalVersions(normalizedServerV);
        }

        return normalizedServerV;
      })();

      return _versionsPromise;
    }

    async function apiGet(action, params = {}) {
      if (action === "getVersions") return rawApiGet(action, params);

      await ensureVersionsFresh();

      const group = groupForAction(action);
      const key = cacheKeyFor(group, action, params);

      const cached = readCache(key);
      if (cached !== null) return cached;

      const data = await rawApiGet(action, params);
      if (data && typeof data === "object" && data.error) return data;

      writeCache(key, data);
      return data;
    }

    setInterval(() => {
      _versionsPromise = null;
      ensureVersionsFresh().catch(() => {});
    }, 120000);

    // ---------- helpers ----------
    function setFieldState(readOnly) {
      ["firstName", "lastName", "horse"].forEach(id => document.getElementById(id).readOnly = readOnly);
    }

    function updateClassButtonText() {
      const btn = document.getElementById("classDropdownBtn");
      if (!btn || btn.disabled) return;

      const selected = [...document.querySelectorAll("#modalCheckboxes input:checked")].length;
      btn.textContent = selected ? `Select Classes (${selected} selected)` : "Select Classes";
    }

    // ---------- init ----------
    document.addEventListener("DOMContentLoaded", async () => {
      const divisionSelect = document.getElementById("division");
      setLoadingSelect(divisionSelect, true, "Loading divisions...", "-- Select Division --");
      try { await populateDivisions(); }
      finally { setLoadingSelect(divisionSelect, false, "Loading divisions...", "-- Select Division --"); }

      const numberInput = document.getElementById("number");
      setLoadingInputPlaceholder(numberInput, true, "Loading rider list...");
      try { await buildRiderNumberList(); }
      finally { setLoadingInputPlaceholder(numberInput, false, "Loading rider list..."); }
    });

    // ---------- divisions ----------
    async function populateDivisions() {
      const divisions = await apiGet("getDivisions");
      const select = document.getElementById("division");
      divisions.forEach(d => {
        const option = document.createElement("option");
        option.value = d;
        option.textContent = d;
        select.appendChild(option);
      });
    }

    // ---------- rider numbers ----------
    async function buildRiderNumberList() {
      const existingMap = await apiGet("getRiderNumberMap");
      const datalist = document.getElementById("riderNumbers");
      datalist.innerHTML = "";

      for (let i = 1; i <= 200; i++) {
        const option = document.createElement("option");
        option.value = i;
        if (existingMap[i]) option.label = existingMap[i];
        datalist.appendChild(option);
      }

      Object.keys(existingMap)
        .map(Number)
        .filter(n => n > 200)
        .sort((a, b) => a - b)
        .forEach(n => {
          const option = document.createElement("option");
          option.value = n;
          option.label = existingMap[n];
          datalist.appendChild(option);
        });
    }

    // ---------- load rider ----------
    async function loadRider() {
      const number = document.getElementById("number").value;
      if (!number) return;

      const numberInput = document.getElementById("number");
      setLoadingInputPlaceholder(numberInput, true, "Loading rider...");
      try {
        const rider = await apiGet("findRider", { number });

        if (rider.exists) {
          firstName.value = rider.firstName || "";
          lastName.value = rider.lastName || "";
          age.value = rider.age || "";
          horse.value = rider.horse || "";
          setFieldState(true);
        } else {
          firstName.value = "";
          lastName.value = "";
          age.value = "";
          horse.value = "";
          setFieldState(false);
        }
      } finally {
        setLoadingInputPlaceholder(numberInput, false, "Loading rider...");
      }
    }

    // ---------- load classes ----------
    async function loadCheckboxes() {
      const division = document.getElementById("division").value;
      if (!division) return;

      const btn = document.getElementById("classDropdownBtn");
      setLoadingButton(btn, true, "Loading...", "Select Classes");

      try {
        const items = await apiGet("getClasses", { division });
        renderClassesIntoModal(items);

        // Always open modal (desktop + mobile)
        //openModal();
        updateClassButtonText();
      } finally {
        setLoadingButton(btn, false, "Loading...", "Select Classes");
        updateClassButtonText();
      }
    }

    function renderClassesIntoModal(items) {
      const modalContainer = document.getElementById("modalCheckboxes");
      modalContainer.innerHTML = "";

      items.forEach((item, i) => {
        const label = document.createElement("label");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = item;
        cb.id = "modal_" + i;
        cb.addEventListener("change", updateClassButtonText);
        label.appendChild(cb);
        label.appendChild(document.createTextNode(" " + item));
        modalContainer.appendChild(label);
      });
    }

    // ✅ Button always opens modal now
    document.getElementById("classDropdownBtn").addEventListener("click", () => {
      const btn = document.getElementById("classDropdownBtn");
      if (btn.disabled) return;
      openModal();
    });

    function openModal() {
      document.getElementById("classModal").style.display = "flex";
      // focus first checkbox if present for keyboard users
      setTimeout(() => {
        const first = document.querySelector("#modalCheckboxes input");
        if (first) first.focus();
      }, 0);
    }

    function closeModal() {
      document.getElementById("classModal").style.display = "none";
      updateClassButtonText();
      // return focus to button
      document.getElementById("classDropdownBtn").focus();
    }

    // ---------- submit ----------
    async function submitForm() {
      const submitBtn = document.querySelector('button[onclick="submitForm()"]');
      if (submitBtn) {
        submitBtn.dataset.normalText = submitBtn.textContent || "Submit";
        submitBtn.textContent = "Submitting...";
        submitBtn.disabled = true;
        submitBtn.setAttribute("aria-busy", "true");
      }

      try {
        // ✅ now read from modal checkboxes
        const selected = [...document.querySelectorAll("#modalCheckboxes input:checked")].map(cb => cb.value);

        const data = {
          number: number.value,
          firstName: firstName.value,
          lastName: lastName.value,
          age: +age.value,
          division: division.value,
          horse: horse.value,
          classes: selected
        };

        if (!data.number || data.classes.length === 0) {
          alert("Rider Number and at least one class are required.");
          return;
        }

        const { res, out } = await rawApiPost("submitForm", data);

        if (!res.ok || out.error) {
          console.error("Submit error:", out);
          alert("Submit failed: " + (out.error || res.statusText));
          return;
        }

        _versionsPromise = null;
        await ensureVersionsFresh().catch(() => {});

        alert(out.updatedExisting ? "Entry updated!" : "Entry created!");
      } finally {
        if (submitBtn) {
          submitBtn.textContent = submitBtn.dataset.normalText || "Submit";
          submitBtn.disabled = false;
          submitBtn.removeAttribute("aria-busy");
        }
      }
    }

    // ----- CLOSE MODAL ONLY WHEN CLICKING THE BACKDROP -----
    const classModal = document.getElementById("classModal");
    const classModalContent = document.getElementById("classModalContent");

    classModal.addEventListener("click", (e) => {
      if (e.target === classModal) closeModal();
    });

    classModalContent.addEventListener("click", (e) => {
      e.stopPropagation();
    });

    // ----- ESC KEY CLOSES MODAL -----
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        if (classModal.style.display === "flex") closeModal();
      }
    });
  </script>
</body>
</html>




